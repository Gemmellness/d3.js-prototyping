<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <style>

        body {
            margin: 0;
            min-width: 800px;
            min-height: 600px;
        }

        rect {
            fill: none;
            pointer-events: all;
        }

        .node circle {
            r: 10;
        }

        .label text{
            font-family: "sans-serif";
            font-weight: bold;
        }

    </style>
</head>

<body onresize="resize()"><script src="http://d3js.org/d3.v4.min.js" charset="utf-8"></script>

<script>
    /* Magic numbers etc */
    var width = innerWidth,
        height = innerHeight;

    // Colours (solarized)
    var baseColours = ['#002b36', '#073642', '#586e75', '#657b83', '#839496', '#93a1a1', '#eee8d5', '#fdf6e3'],
        highlightColours = ['#b58900', '#cb4b16', '#dc322f', '#d33682', '#6c71c4', '#268bd2', '#2aa198', '#859900'];

    /* Assumptions about this data:
     *
     *
     * */

    var branches = ["master", "bugfix1", "macversion"];


    /* Behaviours */
    // Zoom behaviour
    var zoom = d3.zoom()
            .scaleExtent([1, 10])
            .on("zoom", zoomed);

    // Drag behaviour
    var drag = d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged);

    /* Basic containers */
    // Place svg, set size
    var graph = d3.select("body")
            .style("background", baseColours[0])
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + 0 + "," + 0 + ")")
            .call(zoom);

    // Panning rectangle
    var rect = graph.append("rect")
            .attr("width", width)
            .attr("height", height  )
            .style("fill", "none")
            .style("pointer-events", "all");

    var container = graph.append("g");

    var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function(d) { return d.id; }))
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2));

    d3.json("data.json", function(error, data) {
        if (error) throw error;

        // Create edges
        var edges = container.append("g")
                .attr("class", "edges")
                .selectAll(".edge")
                .data(data.edges)
                .enter().append("line")
                .attr("class", "edge")
                .attr("stroke", (function (d) {
                    return highlightColours[branches.indexOf(d.branch) % highlightColours.length];
                }))
                .attr("opacity", 0.6)
                .attr("stroke-width", 3);

        // Create nodes
        var nodes = container.append("g")
                .attr("class", "graph")
                .selectAll("node")
                .data(data.nodes)
                .enter().append("g")
                .attr("class", "commit")
                .append("circle")
                .attr("r", 15)
                .attr("class", "node")
                .attr("fill", function (d) {
                    return highlightColours[branches.indexOf(d.branch) % highlightColours.length];
                })
                .call(drag)
                .on("mouseover", function () {
                    d3.select(this).attr("stroke", baseColours[1])
                            .attr("stroke-width", "1.5px");
                })
                .on('mouseout', function () {
                    d3.select(this).attr("stroke-width", "0px");
                });

        // Create labels
       /* var labels = container.selectAll(".commit")
                .append("text")
                .attr("class", "label")
                .attr("x", function (d) {
                    return d.x + 20
                })
                .attr("y", function (d) {
                    return d.y + 5;
                })
                .text(function (d) {
                    return d.hash
                })
                .attr("fill", baseColours[6]);*/

        simulation.nodes(data.nodes)
                .on("tick", ticked);

        simulation.force("link")
                .links(data.edges);

        function ticked() {
            edges.attr("x1", function (d) {
                return d.source.x;
            })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    });

            nodes.attr("cx", function (d) {
                return d.x;
            })
                    .attr("cy", function (d) {
                        return d.y;
                    });
        }
    });

    /*function updateLabels () {
        labels.attr("x", function (d) {return d.x+20})
                .attr("y", function (d) {return d.y+5;});
    }*/

    function resize() {
        // Update size vars
        width = innerWidth;
        height = innerHeight;

        // Update svg
        d3.selectAll("svg")
            .attr("width", width)
            .attr("height", height);

        // Update rect
        rect.attr("width", width)
            .attr("height", height);
    }

    function zoomed() {
        container.attr("transform", d3.event.transform);
    }

    function dragstarted() {
        d3.event.sourceEvent.stopPropagation();

        if (!d3.event.active)
            simulation.alphaTarget(0.3).restart();
    }

    function dragged(d) {
        d3.select(this).attr("cx", d.x = d3.event.x)
                .attr("cy", d.y = d3.event.y);

        d.fx = d3.event.x;
        d.fy = d3.event.y;
        //updateLabels();
    }

</script></body>