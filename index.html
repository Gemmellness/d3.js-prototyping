<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <style>

        body {
            margin: 0;
            min-width: 800px;
            min-height: 600px;
        }

        rect {
            fill: none;
            pointer-events: all;
        }

        .node circle {
            r: 10;
        }

        .label text{
            font-family: "sans-serif";
            font-weight: bold;
        }

    </style>
</head>

<body onresize="resize()"><script src="http://d3js.org/d3.v4.min.js" charset="utf-8"></script>

<script>


    /* Magic numbers etc */
    var width = innerWidth,
            height = innerHeight;

    // Colours (solarized)
    var baseColours = ['#002b36', '#073642', '#586e75', '#657b83', '#839496', '#93a1a1', '#eee8d5', '#fdf6e3'],
            highlightColours = ['#b58900', '#cb4b16', '#dc322f', '#d33682', '#6c71c4', '#268bd2', '#2aa198', '#859900'];


    /* Behaviours */
    // Zoom behaviour
    var zoom = d3.zoom()
            .scaleExtent([1, 10])
            .on("zoom", zoomed);

    // Drag behaviour
    var drag = d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged);

    /* Basic containers */
    // Place svg, set size
    var graph = d3.select("body")
            .style("background", baseColours[0])
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + 0 + "," + 0 + ")")
            .call(zoom);

    // Panning rectangle
    var rect = graph.append("rect")
            .attr("width", width)
            .attr("height", height  )
            .style("fill", "none")
            .style("pointer-events", "all");

    var container = graph.append("g");

    var logicalGraph = {
        nodes: [],
        edges: []
    };

    /* Assumptions about this data:
     *
     * The first node is the root of the tree
     * All nodes have unique hashes
     * The DAG is connected
     *
     * */
    d3.json("data.json", function(error, data) {
        if (error) throw error;

        logicalGraph.nodes = new Array(data.nodes.length);
        logicalGraph.edges = new Array(data.edges.length);

        var currentLayer = [data.nodes[0]];
        var nextLayer = [];

        var x = 0, y = 0;

        var i = 0;
        while(i < data.nodes.length){
            for(var j = 0; j < currentLayer.length; j++){
                var node = currentLayer[j];

                //Set logical coords
                node.logX = x;
                node.logY = y;
                x++;

                // Store data in data
                logicalGraph.nodes[i] = node;
                i++;

                // Find all child nodes not already in the graph (for the next layer)
                var outEdges = data.edges.filter(function (edge) { return edge.source == node.hash;});

                for(var k = 0; k < outEdges.length; k++){
                    var candidateChild = data.nodes.find(function (node) {return (node.hash == outEdges[k].target)});

                    // Check if already in the graph
                    var previouslyOccurs = false;
                    for(var l = 0; l < logicalGraph.nodes.length && !previouslyOccurs; l++){
                        if (logicalGraph.nodes[l].hash == candidateChild.hash)
                            previouslyOccurs = true;
                    }

                    for(var l = 0; l < nextLayer.length && !previouslyOccurs; l++){
                        if (nextLayer[l].hash == candidateChild.hash)
                            previouslyOccurs = true;
                    }

                    // If not already in graph/next layer, push node to next layer queue
                    if(!previouslyOccurs)
                        nextLayer.push(candidateChild)

                }
            }

            currentLayer = nextLayer;
            nextLayer = [];

            x = 0;
            y++;
        }
    });

    // Create edges
    var edges = container.append("g")
            .attr("class", "edges")
            .selectAll(".edge")
            .data(logicalGraph.edges)
            .enter().append("line")
            .attr("class", "edge")
            .attr("stroke", (function (d) {
                return highlightColours[branches.indexOf(d.branch) % highlightColours.length];
            }))
            .attr("opacity", 0.6)
            .attr("stroke-width", 3);

    // Create nodes
    var nodes = container.append("g")
            .attr("class", "graph")
            .selectAll("node")
            .data(data.nodes)
            .enter().append("g")
            .attr("class", "commit")
            .append("circle")
            .attr("r", 15)
            .attr("class", "node")
            .attr("fill", function (d) {
                return highlightColours[branches.indexOf(d.branch) % highlightColours.length];
            })
            .call(drag)
            .on("mouseover", function () {
                d3.select(this).attr("stroke", baseColours[1])
                        .attr("stroke-width", "1.5px");
            })
            .on('mouseout', function () {
                d3.select(this).attr("stroke-width", "0px");
            });

    // Create labels
    var labels = container.selectAll(".commit")
            .append("text")
            .attr("class", "label")
            .attr("x", function (d) {
                return d.x + 20
            })
            .attr("y", function (d) {
                return d.y + 5;
            })
            .text(function (d) {
                return d.hash
            })
            .attr("fill", baseColours[6]);

    function updateLabels () {
        labels.attr("x", function (d) {return d.x+20})
                .attr("y", function (d) {return d.y+5;});
    }

    function resize() {
        // Update size vars
        width = innerWidth;
        height = innerHeight;

        // Update svg
        d3.selectAll("svg")
            .attr("width", width)
            .attr("height", height);

        // Update rect
        rect.attr("width", width)
            .attr("height", height);
    }

    function zoomed() {
        container.attr("transform", d3.event.transform);
    }

    function dragstarted() {
        d3.event.sourceEvent.stopPropagation();
    }

    function dragged(d) {
        d3.select(this).attr("cx", d.x = d3.event.x)
                .attr("cy", d.y = d3.event.y);
        //updateLabels();
    }

</script></body>